// Prisma schema for nebiswera.com
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "crm", "webinar"]
}

// ===========================================
// Auth Models (NextAuth.js compatible)
// ===========================================

model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  name                    String?
  password                String?   // Hashed password, null for social login
  emailVerified           DateTime? // null = not verified
  emailVerificationSentAt DateTime? // When verification email was sent
  image                   String?
  role                    Role      @default(USER)
  preferredLocale         String    @default("ka") // ka = Georgian, en = English
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  accounts                Account[]
  sessions                Session[]
  contact                 Contact?  // Link to CRM contact if exists

  @@index([createdAt])
  @@schema("public")
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@schema("public")
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("public")
  @@map("sessions")
}

model VerificationToken {
  identifier String    // Email address
  token      String    @unique
  expires    DateTime
  type       TokenType @default(EMAIL_VERIFICATION)

  @@unique([identifier, token])
  @@index([identifier])
  @@index([expires])
  @@index([type])
  @@schema("public")
  @@map("verification_tokens")
}

// ===========================================
// Enums
// ===========================================

enum Role {
  USER
  ADMIN

  @@schema("public")
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET

  @@schema("public")
}

enum EmailType {
  // Transactional types
  VERIFICATION
  PASSWORD_RESET
  WELCOME
  // Marketing types
  CAMPAIGN
  NEWSLETTER
  BROADCAST
  ANNOUNCEMENT

  @@schema("public")
}

enum EmailCategory {
  TRANSACTIONAL
  MARKETING

  @@schema("public")
}

enum EmailStatus {
  SENT
  DELIVERED
  BOUNCED
  SPAM_COMPLAINT
  OPENED

  @@schema("public")
}

// ===========================================
// Email Logging
// ===========================================

model EmailLog {
  id          String        @id @default(cuid())
  messageId   String        @unique
  to          String
  subject     String
  type        EmailType
  category    EmailCategory @default(TRANSACTIONAL)
  status      EmailStatus   @default(SENT)
  locale      String        @default("en")
  sentAt      DateTime      @default(now())
  deliveredAt DateTime?
  openedAt    DateTime?
  bouncedAt   DateTime?
  bounceType  String?
  metadata    Json?

  @@index([status])
  @@index([type])
  @@index([category])
  @@index([sentAt])
  @@index([to])
  @@schema("public")
  @@map("email_logs")
}

// ===========================================
// Application Settings
// ===========================================

model Settings {
  id        String   @id @default("app_settings")

  // Transactional Postmark Configuration
  postmarkServerToken String?
  postmarkStreamName  String   @default("outbound")
  emailFromAddress    String?
  emailFromName       String   @default("Nebiswera")

  // Marketing Postmark Configuration (separate server)
  marketingServerToken String?
  marketingStreamName  String   @default("broadcast")
  marketingFromAddress String?
  marketingFromName    String   @default("ლევან ბახია (წერილები)")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
  @@map("settings")
}

// ===========================================
// Testimonials
// ===========================================

model Testimonial {
  id           String            @id @default(cuid())
  name         String
  email        String?
  text         String            @db.Text
  rating       Int               @default(5)
  submittedAt  DateTime          @default(now())
  locale       String            @default("ka") // ka or en

  // Media
  profilePhoto   String?
  images         String[] // Array of R2 URLs
  audioUrl       String?
  videoUrl       String?         // Raw video URL (R2) - kept as fallback
  videoThumbnail String?         // Auto-generated thumbnail for video
  hlsUrl         String?         // HLS manifest URL for adaptive streaming
  videoStatus    String?         // 'pending' | 'processing' | 'ready' | 'error'

  // Metadata
  status       TestimonialStatus @default(PENDING)
  type         TestimonialType   @default(TEXT)
  source       String?           // "shapo_import" or "website_form"
  tags         String[]          @default([]) // Admin tags for filtering/organizing

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([status])
  @@index([type])
  @@index([submittedAt])
  @@index([locale])
  @@schema("public")
  @@map("testimonials")
}

enum TestimonialStatus {
  PENDING
  APPROVED
  REJECTED

  @@schema("public")
}

enum TestimonialType {
  TEXT
  AUDIO
  VIDEO

  @@schema("public")
}

// ===========================================
// CRM Schema - Contacts Management
// ===========================================

model Contact {
  id            String        @id @default(cuid())
  email         String        @unique
  firstName     String?
  lastName      String?
  phone         String?

  // Source tracking
  source        String        // e.g., "newsletter", "webinar", "import", "manual"
  sourceDetails String?       // Additional context (webinar name, import file, etc.)

  // Link to user (if they register)
  userId        String?       @unique
  user          User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Status
  status        ContactStatus @default(ACTIVE)

  // Marketing preferences
  marketingStatus   MarketingStatus    @default(SUBSCRIBED)
  unsubscribedAt    DateTime?
  unsubscribeReason String?
  suppressionReason SuppressionReason?
  suppressedAt      DateTime?

  // Metadata
  customFields  Json?         // Flexible key-value storage for future needs
  notes         String?       @db.Text

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  tags               ContactTag[]
  activities         ContactActivity[]
  campaignRecipients CampaignRecipient[]

  @@index([email])
  @@index([source])
  @@index([status])
  @@index([marketingStatus])
  @@index([createdAt])
  @@schema("crm")
  @@map("contacts")
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  ARCHIVED

  @@schema("crm")
}

model Tag {
  id          String   @id @default(cuid())
  name        String   @unique
  color       String   @default("#8B5CF6") // Purple default
  description String?
  createdAt   DateTime @default(now())

  contacts    ContactTag[]

  @@schema("crm")
  @@map("tags")
}

model ContactTag {
  contactId  String
  tagId      String
  assignedAt DateTime @default(now())

  contact    Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contactId, tagId])
  @@schema("crm")
  @@map("contact_tags")
}

model ImportLog {
  id             String         @id @default(cuid())
  fileName       String
  totalRows      Int
  successCount   Int
  failedCount    Int
  skippedCount   Int            @default(0)
  updatedCount   Int            @default(0)
  updateStrategy UpdateStrategy @default(SKIP_EXISTING)
  tagsApplied    String[]       @default([]) // Tag IDs applied during import
  errors         Json?          // Array of error messages with row numbers
  importedBy     String         // Admin user ID
  createdAt      DateTime       @default(now())

  @@index([createdAt])
  @@schema("crm")
  @@map("import_logs")
}

enum UpdateStrategy {
  SKIP_EXISTING     // Don't update contacts that already exist
  UPDATE_EMPTY_ONLY // Only fill in missing/empty fields
  OVERWRITE_ALL     // Replace all data for existing contacts
  ADD_TAGS_ONLY     // Just add tags without changing other data

  @@schema("crm")
}

// ===========================================
// Segments (Saved Filters)
// ===========================================

model Segment {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?

  // Filter criteria stored as JSON
  // Example: { status: "ACTIVE", tags: ["tag1", "tag2"], source: "newsletter" }
  filters     Json

  // Cached count (updated periodically or on demand)
  contactCount Int     @default(0)

  createdBy   String   // Admin user ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdAt])
  @@schema("crm")
  @@map("segments")
}

// ===========================================
// Contact Activity Tracking
// ===========================================

model ContactActivity {
  id          String       @id @default(cuid())
  contactId   String
  contact     Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  type        ActivityType
  description String
  metadata    Json?        // Flexible data (e.g., old/new values, email details)
  createdAt   DateTime     @default(now())
  createdBy   String?      // Admin who performed action, null for system

  @@index([contactId])
  @@index([createdAt])
  @@schema("crm")
  @@map("contact_activities")
}

enum ActivityType {
  CREATED        // Contact created
  UPDATED        // Contact info updated
  TAG_ADDED      // Tag added
  TAG_REMOVED    // Tag removed
  STATUS_CHANGED // Status changed
  EMAIL_SENT     // Email sent (linked from EmailLog)
  EMAIL_OPENED   // Email opened
  EMAIL_BOUNCED  // Email bounced
  IMPORTED       // Imported from file
  NOTE_ADDED     // Note added

  @@schema("crm")
}

// ===========================================
// Email Marketing Campaigns
// ===========================================

model Campaign {
  id              String         @id @default(cuid())
  name            String         // Internal name for reference
  subject         String
  previewText     String?        // Preview snippet shown in email clients

  // Content
  htmlContent     String         @db.Text
  textContent     String         @db.Text
  designJson      Json?          // Easy Email editor design JSON (MJML structure) for editing

  // Sender info
  fromName        String
  fromEmail       String
  replyTo         String?

  // Status
  status          CampaignStatus @default(DRAFT)

  // Targeting
  targetType      TargetType
  targetCriteria  Json?          // Flexible: {segmentId, tagIds[], filters}

  // Scheduling
  scheduledAt     DateTime?      // null = manual trigger
  scheduledTz     String         @default("Asia/Tbilisi") // Timezone for scheduling
  sendingStartedAt DateTime?
  completedAt     DateTime?

  // Stats (denormalized for dashboard)
  totalRecipients   Int          @default(0)
  sentCount         Int          @default(0)
  deliveredCount    Int          @default(0)
  openedCount       Int          @default(0)
  clickedCount      Int          @default(0)
  bouncedCount      Int          @default(0)
  unsubscribedCount Int          @default(0)

  createdBy       String         // Admin user ID
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  recipients      CampaignRecipient[]
  links           CampaignLink[]

  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
  @@schema("crm")
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT           // Being edited
  SCHEDULED       // Waiting for scheduledAt
  SENDING         // Currently sending
  PAUSED          // Manually paused mid-send
  COMPLETED       // All recipients processed
  CANCELLED       // Cancelled before completion

  @@schema("crm")
}

enum TargetType {
  ALL_CONTACTS      // Everyone with marketingStatus = SUBSCRIBED
  SEGMENT           // Specific segment
  TAG               // One or more tags
  REGISTERED_USERS  // Users with accounts
  CUSTOM_FILTER     // Custom query

  @@schema("crm")
}

// Individual recipient queue for a campaign
model CampaignRecipient {
  id              String          @id @default(cuid())
  campaignId      String
  campaign        Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId       String
  contact         Contact         @relation(fields: [contactId], references: [id], onDelete: Cascade)
  email           String

  // Snapshot of personalization at send time
  variables       Json?           // {firstName, lastName, email, ...}

  status          RecipientStatus @default(PENDING)
  messageId       String?         // Postmark MessageID for tracking
  sentAt          DateTime?
  error           String?         // Error message if failed

  // Engagement tracking (from webhooks)
  deliveredAt     DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  bouncedAt       DateTime?
  unsubscribedAt  DateTime?

  // Link click tracking
  linkClicks      CampaignLinkClick[]

  @@unique([campaignId, contactId])
  @@index([campaignId, status])
  @@index([messageId])
  @@schema("crm")
  @@map("campaign_recipients")
}

enum RecipientStatus {
  PENDING         // Queued for sending
  SENT            // Sent to Postmark
  DELIVERED       // Delivery confirmed
  FAILED          // Send failed
  SKIPPED         // Skipped (invalid, suppressed, etc.)

  @@schema("crm")
}

// Track individual link clicks per campaign
model CampaignLink {
  id               String   @id @default(cuid())
  campaignId       String
  campaign         Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  url              String   // Original URL
  clickCount       Int      @default(0)
  uniqueClickCount Int      @default(0)

  // Individual clicks stored in CampaignLinkClick
  clicks      CampaignLinkClick[]

  @@unique([campaignId, url])
  @@index([campaignId])
  @@schema("crm")
  @@map("campaign_links")
}

// Individual click events
model CampaignLinkClick {
  id          String            @id @default(cuid())
  linkId      String
  link        CampaignLink      @relation(fields: [linkId], references: [id], onDelete: Cascade)
  recipientId String
  recipient   CampaignRecipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  clickedAt   DateTime          @default(now())

  @@unique([linkId, recipientId])
  @@index([linkId])
  @@index([recipientId])
  @@schema("crm")
  @@map("campaign_link_clicks")
}

// Marketing subscription status
enum MarketingStatus {
  SUBSCRIBED      // Can receive marketing emails
  UNSUBSCRIBED    // Opted out
  SUPPRESSED      // Bounced or complained - cannot send

  @@schema("crm")
}

// Reason for suppression
enum SuppressionReason {
  HARD_BOUNCE
  SPAM_COMPLAINT
  MANUAL_SUPPRESSION

  @@schema("crm")
}

// ===========================================
// Webinar Schema - Webinar Platform
// ===========================================

model Webinar {
  id                String        @id @default(cuid())

  // Basic info
  title             String
  slug              String        @unique
  description       String?       @db.Text

  // Video (Bunny.net Stream)
  hlsUrl            String?       // Bunny Stream HLS URL (playlist.m3u8)
  thumbnailUrl      String?       // Thumbnail image URL
  videoDuration     Int?          // Duration in seconds
  videoStatus       String?       // 'processing' | 'ready' | 'failed'

  // Pages (manually built, referenced here)
  landingPagePath   String?       // e.g., "/webinar/ai-masterclass"
  thankYouPagePath  String?       // e.g., "/webinar/ai-masterclass/thank-you"

  // Settings
  status            WebinarStatus @default(DRAFT)
  timezone          String        @default("Asia/Tbilisi")

  // Presenter info (shown on landing/room)
  presenterName     String?
  presenterTitle    String?
  presenterAvatar   String?
  presenterBio      String?       @db.Text

  // Thank you page customization
  customThankYouPageHtml String?  @db.Text // Custom HTML content shown below standard thank you message

  // Completion settings
  completionPercent Int           @default(80) // % watched to count as "completed"

  // Chat settings
  chatEnabled       Boolean       @default(true)

  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  publishedAt       DateTime?

  // Relations
  scheduleConfig    WebinarScheduleConfig?
  registrationFieldConfig WebinarRegistrationFieldConfig?
  sessions          WebinarSession[]
  interactions      WebinarInteraction[]
  registrations     WebinarRegistration[]
  notifications     WebinarNotification[]
  analyticsEvents   WebinarAnalyticsEvent[]
  chatMessages      WebinarChatMessage[]
  videoProcessingJob VideoProcessingJob?

  @@index([status])
  @@index([slug])
  @@index([createdAt])
  @@schema("webinar")
  @@map("webinars")
}

enum WebinarStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@schema("webinar")
}

// Schedule configuration (like eWebinar's Schedule tab)
model WebinarScheduleConfig {
  id                    String    @id @default(cuid())
  webinarId             String    @unique
  webinar               Webinar   @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  // Event type
  eventType             WebinarEventType @default(RECURRING)

  // Date range
  startsAt              DateTime
  endsAt                DateTime? // null = never ends

  // Recurring schedule (if eventType = RECURRING)
  recurringDays         Int[]     // 0=Sun, 1=Mon, etc. [1,3,5] = Mon,Wed,Fri
  recurringTimes        String[]  // ["09:00", "14:00", "18:00"] in webinar timezone

  // Specific dates (if eventType = SPECIFIC_DATES)
  specificDates         DateTime[]

  // On-demand settings
  onDemandEnabled       Boolean   @default(false)
  onDemandUngated       Boolean   @default(false) // No registration required

  // Just-in-time settings
  justInTimeEnabled     Boolean   @default(false)
  justInTimeMinutes     Int       @default(15) // "Starting in X minutes"

  // Replay settings
  replayEnabled         Boolean   @default(true)
  replayUngated         Boolean   @default(false)
  replayExpiresAfterDays Int?     // Days after session, null = never expires

  // Availability display
  maxSessionsToShow     Int       @default(3)
  blackoutDates         DateTime[]

  // Timezone handling
  useAttendeeTimezone   Boolean   @default(false) // false = use webinar's fixed timezone

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@schema("webinar")
  @@map("webinar_schedule_configs")
}

enum WebinarEventType {
  RECURRING       // Every week on specific days/times
  ONE_TIME        // Single event
  SPECIFIC_DATES  // Multiple specific dates
  ON_DEMAND_ONLY  // No scheduled sessions, only on-demand

  @@schema("webinar")
}

// Registration field configuration (custom fields per webinar)
model WebinarRegistrationFieldConfig {
  id                String    @id @default(cuid())
  webinarId         String    @unique
  webinar           Webinar   @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  // Name field configuration
  nameFormat        NameFieldFormat @default(SPLIT) // SPLIT (firstName + lastName) or FULL (single fullName field)

  // Optional fields toggles
  showPhone         Boolean   @default(false)
  phoneRequired     Boolean   @default(false)

  // Custom fields (JSON array of field definitions)
  // Example: [{"label": "Company", "type": "text", "required": true}]
  customFields      Json      @default("[]")

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@schema("webinar")
  @@map("webinar_registration_field_configs")
}

enum NameFieldFormat {
  SPLIT  // firstName + lastName (two separate fields)
  FULL   // fullName (single field, auto-split on save)

  @@schema("webinar")
}

// Individual webinar session (generated from schedule or manually created)
model WebinarSession {
  id            String          @id @default(cuid())
  webinarId     String
  webinar       Webinar         @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  scheduledAt   DateTime
  type          WebinarSessionType

  // Stats (denormalized for quick access)
  registrationCount Int         @default(0)
  attendeeCount     Int         @default(0)

  createdAt     DateTime        @default(now())

  registrations WebinarRegistration[]

  @@index([webinarId, scheduledAt])
  @@index([scheduledAt])
  @@schema("webinar")
  @@map("webinar_sessions")
}

enum WebinarSessionType {
  SCHEDULED     // Regular scheduled session
  JUST_IN_TIME  // Dynamic "starting soon" session
  ON_DEMAND     // Watch immediately
  REPLAY        // Replay of past session

  @@schema("webinar")
}

// User registration for a webinar
model WebinarRegistration {
  id              String                @id @default(cuid())

  webinarId       String
  webinar         Webinar               @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  sessionId       String?               // null for on-demand
  session         WebinarSession?       @relation(fields: [sessionId], references: [id])

  // Contact info
  email           String
  firstName       String?
  lastName        String?
  phone           String?

  // Custom field responses (JSON object matching customFields from config)
  // Example: {"company": "Acme Inc", "jobTitle": "Developer"}
  customFieldResponses Json?

  // Link to CRM contact (if exists)
  contactId       String?               // References Contact in crm schema

  // Access
  accessToken     String                @unique @default(cuid()) // For unique watch link

  // Session type they registered for
  sessionType     WebinarSessionType

  // Attendance tracking
  status          WebinarRegistrationStatus @default(REGISTERED)
  joinedAt        DateTime?
  leftAt          DateTime?
  lastActiveAt    DateTime?             // Last heartbeat
  watchTimeSeconds Int                  @default(0)
  maxVideoPosition Int                  @default(0) // Furthest point watched (seconds)
  completedAt     DateTime?             // Watched past completion threshold

  // Engagement (calculated)
  engagementScore Float?
  chatMessageCount Int                  @default(0)
  pollResponseCount Int                 @default(0)
  ctaClickCount   Int                   @default(0)

  // Registration source and tracking
  timezone        String                @default("UTC")
  source          String?               // e.g., "direct", "email", "social"
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmContent      String?
  utmTerm         String?

  // Timestamps
  attendedAt      DateTime?             // When they first joined
  registeredAt    DateTime              @default(now())

  // Relations
  analyticsEvents WebinarAnalyticsEvent[]
  chatMessages    WebinarChatMessage[]
  pollResponses   WebinarPollResponse[]
  interactionEvents WebinarInteractionEvent[]

  @@unique([webinarId, email, sessionId])
  @@index([accessToken])
  @@index([email])
  @@index([webinarId, status])
  @@index([contactId])
  @@schema("webinar")
  @@map("webinar_registrations")
}

enum WebinarRegistrationStatus {
  REGISTERED    // Signed up, hasn't attended yet
  ATTENDING     // Currently watching
  ATTENDED      // Watched but didn't complete
  COMPLETED     // Watched past completion threshold
  MISSED        // Didn't show up for scheduled session

  @@schema("webinar")
}

// ===========================================
// Webinar Interactions (Polls, CTAs, etc.)
// ===========================================

model WebinarInteraction {
  id              String              @id @default(cuid())
  webinarId       String
  webinar         Webinar             @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  type            WebinarInteractionType
  triggersAt      Int                 // Seconds into video when this appears
  duration        Int?                // How long visible (null = until dismissed)

  // Content
  title           String
  description     String?             @db.Text
  content         Json                // Type-specific content (options, url, etc.)

  // Behavior
  enabled         Boolean             @default(true)  // Whether interaction is active
  pauseVideo      Boolean             @default(false) // Pause video when shown
  required        Boolean             @default(false) // Must interact to continue
  showOnReplay    Boolean             @default(true)  // Show in replay mode
  dismissable     Boolean             @default(true)  // Can user close it

  // Positioning
  position        WebinarInteractionPosition @default(BOTTOM_RIGHT)

  // Stats (denormalized)
  viewCount       Int                 @default(0)
  actionCount     Int                 @default(0)

  // Ordering (for same timestamp)
  sortOrder       Int                 @default(0)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  pollResponses   WebinarPollResponse[]
  events          WebinarInteractionEvent[]

  @@index([webinarId, triggersAt])
  @@schema("webinar")
  @@map("webinar_interactions")
}

enum WebinarInteractionType {
  POLL            // Multiple choice question
  QUESTION        // Open-ended Q&A prompt
  CTA             // Call to action button/card
  DOWNLOAD        // Downloadable resource
  FEEDBACK        // Rating/emoji feedback
  TIP             // Info tooltip/notification
  SPECIAL_OFFER   // Timed offer with countdown

  @@schema("webinar")
}

enum WebinarInteractionPosition {
  TOP_LEFT
  TOP_RIGHT
  BOTTOM_LEFT
  BOTTOM_RIGHT
  CENTER
  SIDEBAR
  FULL_OVERLAY

  @@schema("webinar")
}

// Poll responses
model WebinarPollResponse {
  id              String              @id @default(cuid())
  interactionId   String
  interaction     WebinarInteraction  @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  registrationId  String
  registration    WebinarRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  // Response data
  selectedOptions Int[]               // For polls: indices of selected options
  textResponse    String?             @db.Text // For open questions
  rating          Int?                // For feedback (1-5 or emoji index)

  respondedAt     DateTime            @default(now())

  @@unique([interactionId, registrationId])
  @@index([interactionId])
  @@schema("webinar")
  @@map("webinar_poll_responses")
}

// Track all interaction events (views, clicks, dismissals)
model WebinarInteractionEvent {
  id              String              @id @default(cuid())
  interactionId   String
  interaction     WebinarInteraction  @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  registrationId  String
  registration    WebinarRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  eventType       WebinarInteractionEventType
  metadata        Json?               // Extra data (clicked URL, etc.)

  createdAt       DateTime            @default(now())

  @@index([interactionId, eventType])
  @@index([registrationId])
  @@schema("webinar")
  @@map("webinar_interaction_events")
}

enum WebinarInteractionEventType {
  VIEWED          // Interaction was shown
  RESPONDED       // User responded to poll/feedback
  CLICKED         // CTA/link clicked
  DISMISSED       // User closed it
  DOWNLOADED      // Download initiated

  @@schema("webinar")
}

// ===========================================
// Webinar Chat
// ===========================================

model WebinarChatMessage {
  id              String              @id @default(cuid())
  webinarId       String
  webinar         Webinar             @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  registrationId  String?             // null = system/moderator/simulated
  registration    WebinarRegistration? @relation(fields: [registrationId], references: [id], onDelete: SetNull)

  // For simulated chat (pre-recorded messages)
  isSimulated     Boolean             @default(false)
  appearsAt       Int?                // Seconds into video (for simulated)

  // Message content
  senderName      String
  message         String              @db.Text

  // Message type/role
  isFromModerator Boolean             @default(false)
  isPrivateReply  Boolean             @default(false) // Only visible to original sender
  replyToId       String?             // ID of message being replied to

  // Moderation
  isHidden        Boolean             @default(false)
  hiddenBy        String?             // Admin who hid it
  hiddenAt        DateTime?

  createdAt       DateTime            @default(now())

  @@index([webinarId, createdAt])
  @@index([webinarId, appearsAt])
  @@index([registrationId])
  @@schema("webinar")
  @@map("webinar_chat_messages")
}

// ===========================================
// Webinar Notifications
// ===========================================

model WebinarNotification {
  id              String              @id @default(cuid())
  webinarId       String
  webinar         Webinar             @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  type            WebinarNotificationType
  trigger         WebinarNotificationTrigger

  // Timing (for reminders/follow-ups)
  triggerMinutes  Int?                // Minutes before/after event

  // Email content
  subject         String
  bodyHtml        String              @db.Text
  bodyText        String?             @db.Text

  // Settings
  enabled         Boolean             @default(true)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Track sent notifications
  sentNotifications WebinarNotificationSent[]

  @@index([webinarId, trigger])
  @@schema("webinar")
  @@map("webinar_notifications")
}

enum WebinarNotificationType {
  CONFIRMATION    // Right after registration
  REMINDER        // Before webinar
  FOLLOW_UP       // After webinar

  @@schema("webinar")
}

enum WebinarNotificationTrigger {
  // Confirmations
  REGISTERED_SCHEDULED    // Registered for scheduled session
  REGISTERED_REPLAY       // Registered for replay
  REGISTERED_ON_DEMAND    // Registered for on-demand

  // Reminders (triggerMinutes before scheduledAt)
  REMINDER_BEFORE         // X minutes before start

  // Follow-ups (triggerMinutes after session ended)
  FOLLOW_UP_ATTENDED      // Attended the webinar
  FOLLOW_UP_COMPLETED     // Watched past completion threshold
  FOLLOW_UP_MISSED        // Didn't show up
  FOLLOW_UP_LEFT_EARLY    // Left before completion

  @@schema("webinar")
}

// Track sent notification instances
model WebinarNotificationSent {
  id              String              @id @default(cuid())
  notificationId  String
  notification    WebinarNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  registrationId  String
  email           String
  scheduledFor    DateTime
  sentAt          DateTime?
  status          WebinarNotificationSentStatus @default(PENDING)
  error           String?

  @@unique([notificationId, registrationId])
  @@index([scheduledFor, status])
  @@schema("webinar")
  @@map("webinar_notifications_sent")
}

enum WebinarNotificationSentStatus {
  PENDING
  SENT
  FAILED
  CANCELLED

  @@schema("webinar")
}

// ===========================================
// Webinar Analytics
// ===========================================

model WebinarAnalyticsEvent {
  id              String              @id @default(cuid())
  webinarId       String
  webinar         Webinar             @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  registrationId  String?
  registration    WebinarRegistration? @relation(fields: [registrationId], references: [id], onDelete: SetNull)

  // Event info
  eventType       WebinarAnalyticsEventType
  videoPosition   Int?                // Seconds into video
  metadata        Json?               // Event-specific data

  // Session context
  sessionId       String?
  sessionType     WebinarSessionType?

  // Client info (for debugging)
  userAgent       String?
  ipAddress       String?

  createdAt       DateTime            @default(now())

  @@index([webinarId, eventType])
  @@index([webinarId, createdAt])
  @@index([registrationId, createdAt])
  @@schema("webinar")
  @@map("webinar_analytics_events")
}

enum WebinarAnalyticsEventType {
  // Page events
  LANDING_PAGE_VIEW
  REGISTRATION_STARTED
  REGISTRATION_COMPLETED
  REGISTRATION            // Backwards compat alias

  // Attendance events
  JOINED_WAITING_ROOM
  WEBINAR_STARTED
  WEBINAR_ENDED
  LEFT_EARLY
  REJOINED
  ATTENDANCE              // First joined the webinar

  // Engagement events
  CHAT_SENT
  POLL_ANSWERED
  CTA_CLICKED
  DOWNLOAD_CLICKED
  QUESTION_SUBMITTED
  FEEDBACK_GIVEN
  REACTION_SENT

  // Video events
  VIDEO_HEARTBEAT     // Sent every 30 seconds
  VIDEO_BUFFERING
  VIDEO_ERROR
  VIDEO_QUALITY_CHANGE

  // Replay events
  REPLAY_STARTED
  REPLAY_SEEKED
  REPLAY_COMPLETED

  @@schema("webinar")
}

// ===========================================
// Video Processing (Bunny.net Stream)
// ===========================================

model VideoProcessingJob {
  id              String                @id @default(cuid())
  webinarId       String                @unique
  webinar         Webinar               @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  status          VideoProcessingStatus @default(PENDING)
  progress        Int                   @default(0) // 0-100

  // Source
  originalUrl     String                // Original upload URL
  originalSize    BigInt?               // File size in bytes

  // Bunny.net Stream video ID
  bunnyVideoId    String?               @map("coconutJobId") // Mapped to preserve existing column

  // Output (populated after processing)
  hlsUrl          String?               // Bunny Stream HLS URL
  thumbnailUrl    String?               // Bunny Stream thumbnail URL
  duration        Int?                  // Duration in seconds

  // Processing info
  startedAt       DateTime?
  completedAt     DateTime?
  error           String?
  retryCount      Int                   @default(0)

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([bunnyVideoId])
  @@schema("webinar")
  @@map("video_processing_jobs")
}

enum VideoProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@schema("webinar")
}
