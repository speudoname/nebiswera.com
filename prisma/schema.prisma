// Prisma schema for nebiswera.com
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "crm", "webinar", "lms"]
}

// ===========================================
// Auth Models (NextAuth.js compatible)
// ===========================================

model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  name                    String?   // Default/fallback name
  nameKa                  String?   // Georgian name (for blog authors)
  nameEn                  String?   // English name (for blog authors)
  password                String?   // Hashed password, null for social login
  emailVerified           DateTime? // null = not verified
  emailVerificationSentAt DateTime? // When verification email was sent
  image                   String?
  role                    Role      @default(USER)
  preferredLocale         String    @default("ka") // ka = Georgian, en = English
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  accounts                Account[]
  sessions                Session[]
  contact                 Contact?  // Link to CRM contact if exists

  // LMS Relations
  enrollments             Enrollment[]
  quizAttempts            LmsQuizAttempt[]

  @@index([createdAt])
  @@schema("public")
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@schema("public")
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("public")
  @@map("sessions")
}

model VerificationToken {
  identifier String    // Email address
  token      String    @unique
  expires    DateTime
  type       TokenType @default(EMAIL_VERIFICATION)

  @@unique([identifier, token])
  @@index([identifier])
  @@index([expires])
  @@index([type])
  @@schema("public")
  @@map("verification_tokens")
}

// ===========================================
// Enums
// ===========================================

enum Role {
  USER
  ADMIN

  @@schema("public")
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET

  @@schema("public")
}

enum EmailType {
  // Transactional types
  VERIFICATION
  PASSWORD_RESET
  WELCOME
  // Marketing types
  CAMPAIGN
  NEWSLETTER
  BROADCAST
  ANNOUNCEMENT
  // Webinar types (transactional nature, sent via transactional server)
  WEBINAR
  // Course/LMS types (transactional nature)
  COURSE

  @@schema("public")
}

enum EmailCategory {
  TRANSACTIONAL
  MARKETING

  @@schema("public")
}

enum EmailStatus {
  SENT
  DELIVERED
  BOUNCED
  SPAM_COMPLAINT
  OPENED

  @@schema("public")
}

// ===========================================
// Email Logging
// ===========================================

model EmailLog {
  id          String        @id @default(cuid())
  messageId   String        @unique
  to          String
  subject     String
  type        EmailType
  category    EmailCategory @default(TRANSACTIONAL)
  status      EmailStatus   @default(SENT)
  locale      String        @default("en")
  sentAt      DateTime      @default(now())
  deliveredAt DateTime?
  openedAt    DateTime?
  bouncedAt   DateTime?
  bounceType  String?
  metadata    Json?

  @@index([status])
  @@index([type])
  @@index([category])
  @@index([sentAt])
  @@index([to])
  @@schema("public")
  @@map("email_logs")
}

// ===========================================
// Application Settings
// ===========================================

model Settings {
  id        String   @id @default("app_settings")

  // Transactional Postmark Configuration
  postmarkServerToken String?
  postmarkStreamName  String   @default("outbound")
  emailFromAddress    String?
  emailFromName       String   @default("Nebiswera")

  // Marketing Postmark Configuration (separate server)
  marketingServerToken String?
  marketingStreamName  String   @default("broadcast")
  marketingFromAddress String?
  marketingFromName    String   @default("ლევან ბახია (წერილები)")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
  @@map("settings")
}

// ===========================================
// Testimonials
// ===========================================

model Testimonial {
  id           String            @id @default(cuid())
  name         String
  email        String?
  text         String            @db.Text
  rating       Int               @default(5)
  submittedAt  DateTime          @default(now())
  locale       String            @default("ka") // ka or en

  // Media
  profilePhoto   String?
  images         String[] // Array of R2 URLs
  audioUrl       String?
  videoUrl       String?         // Raw video URL (R2) - kept as fallback
  videoThumbnail String?         // Auto-generated thumbnail for video
  hlsUrl         String?         // HLS manifest URL for adaptive streaming
  videoStatus    String?         // 'pending' | 'processing' | 'ready' | 'error'

  // Metadata
  status       TestimonialStatus @default(PENDING)
  type         TestimonialType   @default(TEXT)
  source       String?           // "shapo_import" or "website_form"
  tags         String[]          @default([]) // Admin tags for filtering/organizing

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([status])
  @@index([type])
  @@index([submittedAt])
  @@index([locale])
  @@schema("public")
  @@map("testimonials")
}

enum TestimonialStatus {
  PENDING
  APPROVED
  REJECTED

  @@schema("public")
}

enum TestimonialType {
  TEXT
  AUDIO
  VIDEO

  @@schema("public")
}

enum BlogPostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@schema("public")
}

// ===========================================
// Blog Posts
// ===========================================

model BlogPost {
  id              String          @id @default(cuid())

  // Slugs (for both languages - URLs)
  slugKa          String          @unique // Georgian URL slug
  slugEn          String          @unique // English URL slug

  // Content - Georgian
  titleKa         String
  excerptKa       String?         @db.Text // Short description for cards/previews
  contentKa       String          @db.Text // Rich HTML content

  // Content - English
  titleEn         String
  excerptEn       String?         @db.Text
  contentEn       String          @db.Text

  // Featured image
  featuredImage   String?         // CDN URL
  featuredImageAlt String?        // Alt text for accessibility

  // SEO - Georgian (auto-generated but editable)
  seoTitleKa      String?         // Falls back to titleKa if empty
  seoDescriptionKa String?        // Falls back to excerptKa if empty
  ogImageKa       String?         // Falls back to featuredImage if empty

  // SEO - English
  seoTitleEn      String?
  seoDescriptionEn String?
  ogImageEn       String?

  // Categorization
  category        String?         // Main category
  tags            String[]        @default([]) // Array of tag strings

  // Publishing
  status          BlogPostStatus  @default(DRAFT)
  publishedAt     DateTime?       // When it was/will be published
  publishedKa     Boolean         @default(false) // Is Georgian version ready/visible
  publishedEn     Boolean         @default(false) // Is English version ready/visible

  // Author
  authorId        String?         // User ID if we want to track author
  authorName      String?         // Display name (can be overridden)
  authorAvatar    String?         // Avatar URL

  // Reading metrics
  readingTimeMinutes Int?         // Estimated reading time

  // Engagement (can be updated via analytics)
  viewCount       Int             @default(0)

  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([status, publishedAt])
  @@index([category])
  @@index([createdAt])
  @@schema("public")
  @@map("blog_posts")
}

// ===========================================
// CRM Schema - Contacts Management
// ===========================================

model Contact {
  id            String        @id @default(cuid())
  email         String        @unique
  firstName     String?
  lastName      String?
  phone         String?

  // Source tracking
  source        String        // e.g., "newsletter", "webinar", "import", "manual"
  sourceDetails String?       // Additional context (webinar name, import file, etc.)

  // Link to user (if they register)
  userId        String?       @unique
  user          User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Status
  status        ContactStatus @default(ACTIVE)

  // Marketing preferences
  marketingStatus   MarketingStatus    @default(SUBSCRIBED)
  unsubscribedAt    DateTime?
  unsubscribeReason String?
  suppressionReason SuppressionReason?
  suppressedAt      DateTime?

  // Metadata
  customFields  Json?         // Flexible key-value storage for future needs
  notes         String?       @db.Text

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  tags               ContactTag[]
  activities         ContactActivity[]
  campaignRecipients CampaignRecipient[]
  webinarRegistrations WebinarRegistration[] @relation("ContactWebinarRegistrations")

  @@index([email])
  @@index([source])
  @@index([status])
  @@index([marketingStatus])
  @@index([email, marketingStatus]) // Composite index for filtered email lookups in campaigns
  @@index([createdAt])
  @@schema("crm")
  @@map("contacts")
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  ARCHIVED

  @@schema("crm")
}

model Tag {
  id          String   @id @default(cuid())
  name        String   @unique
  color       String   @default("#8B5CF6") // Purple default
  description String?
  createdAt   DateTime @default(now())

  contacts    ContactTag[]

  @@schema("crm")
  @@map("tags")
}

model ContactTag {
  contactId  String
  tagId      String
  assignedAt DateTime @default(now())

  contact    Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contactId, tagId])
  @@schema("crm")
  @@map("contact_tags")
}

model ImportLog {
  id             String         @id @default(cuid())
  fileName       String
  totalRows      Int
  successCount   Int
  failedCount    Int
  skippedCount   Int            @default(0)
  updatedCount   Int            @default(0)
  updateStrategy UpdateStrategy @default(SKIP_EXISTING)
  tagsApplied    String[]       @default([]) // Tag IDs applied during import
  errors         Json?          // Array of error messages with row numbers
  importedBy     String         // Admin user ID
  createdAt      DateTime       @default(now())

  @@index([createdAt])
  @@schema("crm")
  @@map("import_logs")
}

enum UpdateStrategy {
  SKIP_EXISTING     // Don't update contacts that already exist
  UPDATE_EMPTY_ONLY // Only fill in missing/empty fields
  OVERWRITE_ALL     // Replace all data for existing contacts
  ADD_TAGS_ONLY     // Just add tags without changing other data

  @@schema("crm")
}

// ===========================================
// Segments (Saved Filters)
// ===========================================

model Segment {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?

  // Filter criteria stored as JSON
  // Example: { status: "ACTIVE", tags: ["tag1", "tag2"], source: "newsletter" }
  filters     Json

  // Cached count (updated periodically or on demand)
  contactCount Int     @default(0)

  createdBy   String   // Admin user ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdAt])
  @@schema("crm")
  @@map("segments")
}

// ===========================================
// Contact Activity Tracking
// ===========================================

model ContactActivity {
  id          String       @id @default(cuid())
  contactId   String
  contact     Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  type        ActivityType
  description String
  metadata    Json?        // Flexible data (e.g., old/new values, email details)
  createdAt   DateTime     @default(now())
  createdBy   String?      // Admin who performed action, null for system

  @@index([contactId])
  @@index([createdAt])
  @@schema("crm")
  @@map("contact_activities")
}

enum ActivityType {
  CREATED              // Contact created
  UPDATED              // Contact info updated
  TAG_ADDED            // Tag added
  TAG_REMOVED          // Tag removed
  STATUS_CHANGED       // Status changed
  EMAIL_SENT           // Email sent (linked from EmailLog)
  EMAIL_OPENED         // Email opened
  EMAIL_BOUNCED        // Email bounced
  IMPORTED             // Imported from file
  NOTE_ADDED           // Note added
  WEBINAR_REGISTERED   // Registered for webinar
  WEBINAR_ATTENDED     // Attended webinar
  WEBINAR_COMPLETED    // Completed webinar (watched past threshold)
  WEBINAR_MISSED       // Registered but didn't attend

  @@schema("crm")
}

// ===========================================
// Email Marketing Campaigns
// ===========================================

model Campaign {
  id              String         @id @default(cuid())
  name            String         // Internal name for reference
  subject         String
  previewText     String?        // Preview snippet shown in email clients

  // Content
  htmlContent     String         @db.Text
  textContent     String         @db.Text
  designJson      Json?          // Easy Email editor design JSON (MJML structure) for editing

  // Sender info
  fromName        String
  fromEmail       String
  replyTo         String?

  // Status
  status          CampaignStatus @default(DRAFT)

  // Targeting
  targetType      TargetType
  targetCriteria  Json?          // Flexible: {segmentId, tagIds[], filters}

  // Scheduling
  scheduledAt     DateTime?      // null = manual trigger
  scheduledTz     String         @default("Asia/Tbilisi") // Timezone for scheduling
  sendingStartedAt DateTime?
  completedAt     DateTime?

  // Stats (denormalized for dashboard)
  totalRecipients   Int          @default(0)
  sentCount         Int          @default(0)
  deliveredCount    Int          @default(0)
  openedCount       Int          @default(0)
  clickedCount      Int          @default(0)
  bouncedCount      Int          @default(0)
  unsubscribedCount Int          @default(0)

  createdBy       String         // Admin user ID
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  recipients      CampaignRecipient[]
  links           CampaignLink[]

  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
  @@schema("crm")
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT           // Being edited
  SCHEDULED       // Waiting for scheduledAt
  SENDING         // Currently sending
  PAUSED          // Manually paused mid-send
  COMPLETED       // All recipients processed
  CANCELLED       // Cancelled before completion

  @@schema("crm")
}

enum TargetType {
  ALL_CONTACTS      // Everyone with marketingStatus = SUBSCRIBED
  SEGMENT           // Specific segment
  TAG               // One or more tags
  REGISTERED_USERS  // Users with accounts
  CUSTOM_FILTER     // Custom query

  @@schema("crm")
}

// Individual recipient queue for a campaign
model CampaignRecipient {
  id              String          @id @default(cuid())
  campaignId      String
  campaign        Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId       String
  contact         Contact         @relation(fields: [contactId], references: [id], onDelete: Cascade)
  email           String

  // Snapshot of personalization at send time
  variables       Json?           // {firstName, lastName, email, ...}

  status          RecipientStatus @default(PENDING)
  messageId       String?         // Postmark MessageID for tracking
  sentAt          DateTime?
  error           String?         // Error message if failed

  // Engagement tracking (from webhooks)
  deliveredAt     DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  bouncedAt       DateTime?
  unsubscribedAt  DateTime?

  // Link click tracking
  linkClicks      CampaignLinkClick[]

  @@unique([campaignId, contactId])
  @@index([campaignId, status])
  @@index([messageId])
  @@schema("crm")
  @@map("campaign_recipients")
}

enum RecipientStatus {
  PENDING         // Queued for sending
  SENT            // Sent to Postmark
  DELIVERED       // Delivery confirmed
  FAILED          // Send failed
  SKIPPED         // Skipped (invalid, suppressed, etc.)

  @@schema("crm")
}

// Track individual link clicks per campaign
model CampaignLink {
  id               String   @id @default(cuid())
  campaignId       String
  campaign         Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  url              String   // Original URL
  clickCount       Int      @default(0)
  uniqueClickCount Int      @default(0)

  // Individual clicks stored in CampaignLinkClick
  clicks      CampaignLinkClick[]

  @@unique([campaignId, url])
  @@index([campaignId])
  @@schema("crm")
  @@map("campaign_links")
}

// Individual click events
model CampaignLinkClick {
  id          String            @id @default(cuid())
  linkId      String
  link        CampaignLink      @relation(fields: [linkId], references: [id], onDelete: Cascade)
  recipientId String
  recipient   CampaignRecipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  clickedAt   DateTime          @default(now())

  @@unique([linkId, recipientId])
  @@index([linkId])
  @@index([recipientId])
  @@schema("crm")
  @@map("campaign_link_clicks")
}

// Marketing subscription status
enum MarketingStatus {
  SUBSCRIBED      // Can receive marketing emails
  UNSUBSCRIBED    // Opted out
  SUPPRESSED      // Bounced or complained - cannot send

  @@schema("crm")
}

// Reason for suppression
enum SuppressionReason {
  HARD_BOUNCE
  SPAM_COMPLAINT
  MANUAL_SUPPRESSION

  @@schema("crm")
}

// ===========================================
// Webinar Schema - Webinar Platform
// ===========================================

model Webinar {
  id                String        @id @default(cuid())

  // Basic info
  title             String
  slug              String        @unique
  description       String?       @db.Text

  // Video (Bunny.net Stream)
  hlsUrl            String?       // Bunny Stream HLS URL (playlist.m3u8)
  thumbnailUrl      String?       // Thumbnail image URL
  videoDuration     Int?          // Duration in seconds
  videoStatus       String?       // 'processing' | 'ready' | 'failed'

  // Settings
  status            WebinarStatus @default(DRAFT)
  language          String        @default("ka") // 'ka' (Georgian), 'en' (English)
  timezone          String        @default("Asia/Tbilisi")

  // Presenter info (shown on landing/room)
  presenterName     String?
  presenterTitle    String?
  presenterAvatar   String?
  presenterBio      String?       @db.Text

  // Thank you page customization
  customThankYouPageHtml String?  @db.Text // Custom HTML content shown below standard thank you message

  // Completion settings
  completionPercent Int           @default(80) // % watched to count as "completed"

  // End screen configuration
  endScreenEnabled  Boolean       @default(true)
  endScreenTitle    String?       @db.Text // Main heading on end screen
  endScreenMessage  String?       @db.Text // Body text on end screen
  endScreenButtonText String?     // CTA button text (optional)
  endScreenButtonUrl  String?     // CTA button URL (optional)
  endScreenRedirectUrl String?    // Auto-redirect URL (optional)
  endScreenRedirectDelay Int?     // Minutes before redirect (optional)

  // Chat settings
  chatEnabled       Boolean       @default(true)
  chatScript        Json?         // Simulated chat bot script: { enabled: boolean, messages: [{time, sender, message}] }

  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  publishedAt       DateTime?

  // Relations
  scheduleConfig    WebinarScheduleConfig?
  registrationFieldConfig WebinarRegistrationFieldConfig?
  landingPageConfig WebinarLandingPageConfig?
  sessions          WebinarSession[]
  interactions      WebinarInteraction[]
  registrations     WebinarRegistration[]
  notifications     WebinarNotification[]
  automationRules   WebinarAutomationRule[]
  analyticsEvents   WebinarAnalyticsEvent[]
  chatMessages      WebinarChatMessage[]
  videoProcessingJob VideoProcessingJob?

  @@index([status])
  @@index([slug])
  @@index([createdAt])
  @@schema("webinar")
  @@map("webinars")
}

enum WebinarStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@schema("webinar")
}

// Schedule configuration (like eWebinar's Schedule tab)
model WebinarScheduleConfig {
  id                    String    @id @default(cuid())
  webinarId             String    @unique
  webinar               Webinar   @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  // Event type
  eventType             WebinarEventType @default(RECURRING)

  // Date range
  startsAt              DateTime
  endsAt                DateTime? // null = never ends

  // Recurring schedule (if eventType = RECURRING)
  recurringDays         Int[]     // 0=Sun, 1=Mon, etc. [1,3,5] = Mon,Wed,Fri
  recurringTimes        String[]  // ["09:00", "14:00", "18:00"] in webinar timezone

  // Specific dates (if eventType = SPECIFIC_DATES)
  specificDates         DateTime[]

  // On-demand settings
  onDemandEnabled       Boolean   @default(false)
  onDemandUngated       Boolean   @default(false) // No registration required

  // Just-in-time settings (simplified to fixed intervals)
  justInTimeEnabled     Boolean   @default(false)
  intervalMinutes       Int       @default(15) // Fixed interval: 5, 15, 30, or 60 minutes
  intervalStartHour     Int       @default(9)  // Start hour (e.g., 9 = 9 AM)
  intervalEndHour       Int       @default(17) // End hour (e.g., 17 = 5 PM)

  // Replay settings
  replayEnabled         Boolean   @default(true)
  replayUngated         Boolean   @default(false)
  replayExpiresAfterDays Int?     // Days after session, null = never expires

  // Availability display
  maxSessionsToShow     Int       @default(3)
  blackoutDates         DateTime[]

  // Timezone handling
  useAttendeeTimezone   Boolean   @default(false) // false = use webinar's fixed timezone

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@schema("webinar")
  @@map("webinar_schedule_configs")
}

enum WebinarEventType {
  RECURRING       // Every week on specific days/times
  ONE_TIME        // Single event
  SPECIFIC_DATES  // Multiple specific dates
  ON_DEMAND_ONLY  // No scheduled sessions, only on-demand

  @@schema("webinar")
}

// Registration field configuration (custom fields per webinar)
model WebinarRegistrationFieldConfig {
  id                String    @id @default(cuid())
  webinarId         String    @unique
  webinar           Webinar   @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  // Name field configuration
  nameFormat        NameFieldFormat @default(SPLIT) // SPLIT (firstName + lastName) or FULL (single fullName field)

  // Optional fields toggles
  showPhone         Boolean   @default(false)
  phoneRequired     Boolean   @default(false)

  // Custom fields (JSON array of field definitions)
  // Example: [{"label": "Company", "type": "text", "required": true}]
  customFields      Json      @default("[]")

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@schema("webinar")
  @@map("webinar_registration_field_configs")
}

enum NameFieldFormat {
  SPLIT  // firstName + lastName (two separate fields)
  FULL   // fullName (single field, auto-split on save)

  @@schema("webinar")
}

// Landing page configuration for webinar
model WebinarLandingPageConfig {
  id                String    @id @default(cuid())
  webinarId         String    @unique
  webinar           Webinar   @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  // Template choice (layout variation)
  template          LandingPageTemplate @default(IMAGE_RIGHT)

  // Header
  logoType          LogoType  @default(TEXT)
  logoText          String?   // Text logo (e.g., ":::...ნებისწერა...:::")
  logoImageUrl      String?   // Image logo URL

  // Section 1: Above the fold
  heroEyebrow       String?
  heroTitle         String?
  heroTitleParts    Json?     // Rich text: [{ text, bold, color, italic }]
  heroSubtitle      String?
  heroSubtitleParts Json?     // Rich text: [{ text, bold, color, italic }]
  heroParagraph     String?   @db.Text
  heroButtonText    String?
  heroBelowButtonText String?
  heroButtonStyle   ButtonStyle @default(POPUP_FORM)
  heroMediaType     HeroMediaType @default(IMAGE)
  heroImageUrl      String?
  heroVideoUrl      String?       // Video URL (for VIDEO media type)
  heroImagePlacement ImagePlacement @default(RIGHT)
  heroAlignment     ContentAlignment @default(LEFT) // Text alignment in hero

  // Section 2: Below the fold
  section2Title     String?   // e.g., "Here's what you'll learn"
  // List items stored as JSON: [{ headline, subheadline, paragraph }]
  section2Items     Json      @default("[]")
  section2CtaText   String?   // Call to action text
  section2SubCtaText String?  // Sub-CTA text (for date or other info)
  section2ButtonText String?
  section2ButtonStyle ButtonStyle @default(POPUP_FORM)
  section2ImagePlacement ImagePlacement @default(RIGHT) // Independent section 2 layout
  section2Alignment ContentAlignment @default(LEFT)     // Section 2 text alignment
  presenterImageUrl String?   // Presenter photo
  presenterImageShape PresenterImageShape @default(CIRCLE)

  // Footer
  footerDisclaimerText String? @db.Text

  // Color customization (optional, defaults to site palette)
  primaryColor      String?   // Hex color
  backgroundColor   String?   // Hex color

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@schema("webinar")
  @@map("webinar_landing_page_configs")
}

enum LandingPageTemplate {
  // Classic two-column layouts
  IMAGE_RIGHT           // 1. Two-column: text left, image right
  IMAGE_LEFT            // 2. Two-column: image left, text right

  // Centered layouts
  CENTERED_HERO         // 3. Centered single column with video/image below headline
  CENTERED_MINIMAL      // 4. Ultra-clean minimal centered, lots of whitespace

  // Full-width image layouts
  IMAGE_BACKGROUND      // 5. Full-width background image with text overlay
  GRADIENT_OVERLAY      // 6. Gradient background with subtle image blend

  // Feature-focused layouts
  VIDEO_FOCUS           // 7. Large video/image prominent, compact text
  CARD_FLOAT            // 8. Content in floating card over background

  // Split layouts
  SPLIT_DIAGONAL        // 9. Diagonal split between content and image

  @@schema("webinar")
}

enum ContentAlignment {
  LEFT
  CENTER
  RIGHT

  @@schema("webinar")
}

enum ButtonStyle {
  POPUP_FORM       // Opens registration form in popup/modal
  INLINE_EMAIL     // Inline email input + button (like homepage)
  EXPAND_FORM      // Expands registration form in-place

  @@schema("webinar")
}

enum ImagePlacement {
  LEFT
  RIGHT
  BACKGROUND
  NONE

  @@schema("webinar")
}

enum HeroMediaType {
  IMAGE
  VIDEO

  @@schema("webinar")
}

enum PresenterImageShape {
  CIRCLE
  SQUARE

  @@schema("webinar")
}

enum LogoType {
  TEXT
  IMAGE

  @@schema("webinar")
}

// Individual webinar session (generated from schedule or manually created)
model WebinarSession {
  id            String          @id @default(cuid())
  webinarId     String
  webinar       Webinar         @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  scheduledAt   DateTime
  type          WebinarSessionType

  // Stats (denormalized for quick access)
  registrationCount Int         @default(0)
  attendeeCount     Int         @default(0)

  createdAt     DateTime        @default(now())

  registrations WebinarRegistration[]

  @@index([webinarId, scheduledAt])
  @@index([scheduledAt])
  @@schema("webinar")
  @@map("webinar_sessions")
}

enum WebinarSessionType {
  SCHEDULED     // Regular scheduled session
  JUST_IN_TIME  // Dynamic "starting soon" session
  ON_DEMAND     // Watch immediately
  REPLAY        // Replay of past session

  @@schema("webinar")
}

// User registration for a webinar
model WebinarRegistration {
  id              String                @id @default(cuid())

  webinarId       String
  webinar         Webinar               @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  sessionId       String?               // null for on-demand
  session         WebinarSession?       @relation(fields: [sessionId], references: [id])

  // Contact info
  email           String
  firstName       String?
  lastName        String?
  phone           String?

  // Custom field responses (JSON object matching customFields from config)
  // Example: {"company": "Acme Inc", "jobTitle": "Developer"}
  customFieldResponses Json?

  // Link to CRM contact (synced automatically on registration)
  contactId       String?
  contact         Contact?              @relation("ContactWebinarRegistrations", fields: [contactId], references: [id], onDelete: SetNull, map: "fk_webinar_registration_contact")

  // Access
  accessToken     String                @unique @default(cuid()) // For unique watch link

  // Session type they registered for
  sessionType     WebinarSessionType
  sessionStartTime DateTime?             // Calculated at registration: when this session starts

  // Attendance tracking
  status          WebinarRegistrationStatus @default(REGISTERED)
  joinedAt        DateTime?
  leftAt          DateTime?
  lastActiveAt    DateTime?             // Last heartbeat
  watchTimeSeconds Int                  @default(0)
  maxVideoPosition Int                  @default(0) // Furthest point watched (seconds)
  completedAt     DateTime?             // Watched past completion threshold

  // Engagement (calculated)
  engagementScore Float?
  chatMessageCount Int                  @default(0)
  pollResponseCount Int                 @default(0)
  ctaClickCount   Int                   @default(0)

  // Registration source and tracking
  timezone        String                @default("UTC")
  source          String?               // e.g., "direct", "email", "social"
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmContent      String?
  utmTerm         String?

  // Timestamps
  attendedAt      DateTime?             // When they first joined
  registeredAt    DateTime              @default(now())

  // Relations
  analyticsEvents WebinarAnalyticsEvent[]
  chatMessages    WebinarChatMessage[]
  pollResponses   WebinarPollResponse[]
  interactionEvents WebinarInteractionEvent[]
  notificationQueue WebinarNotificationQueue[]
  notificationLogs  WebinarNotificationLog[]

  @@unique([webinarId, email, sessionId])
  @@index([accessToken])
  @@index([email])
  @@index([email, webinarId]) // Composite index for email-based registration lookups
  @@index([webinarId, status])
  @@index([contactId])
  @@schema("webinar")
  @@map("webinar_registrations")
}

enum WebinarRegistrationStatus {
  REGISTERED    // Signed up, hasn't attended yet
  ATTENDING     // Currently watching
  ATTENDED      // Watched but didn't complete
  COMPLETED     // Watched past completion threshold
  MISSED        // Didn't show up for scheduled session

  @@schema("webinar")
}

// ===========================================
// Webinar Interactions (Polls, CTAs, etc.)
// ===========================================

model WebinarInteraction {
  id              String              @id @default(cuid())
  webinarId       String
  webinar         Webinar             @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  type            WebinarInteractionType
  triggersAt      Int                 // Seconds into video when this appears
  duration        Int?                // How long visible (null = until dismissed)

  // Content
  title           String
  description     String?             @db.Text
  content         Json                // Type-specific content (options, url, etc.)

  // Behavior
  enabled         Boolean             @default(true)  // Whether interaction is active
  pauseVideo      Boolean             @default(false) // Pause video when shown
  required        Boolean             @default(false) // Must interact to continue
  showOnReplay    Boolean             @default(true)  // Show in replay mode
  dismissable     Boolean             @default(true)  // Can user close it

  // Positioning
  position        WebinarInteractionPosition @default(BOTTOM_RIGHT)

  // Stats (denormalized)
  viewCount       Int                 @default(0)
  actionCount     Int                 @default(0)

  // Ordering (for same timestamp)
  sortOrder       Int                 @default(0)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  pollResponses   WebinarPollResponse[]
  events          WebinarInteractionEvent[]

  @@index([webinarId, triggersAt])
  @@schema("webinar")
  @@map("webinar_interactions")
}

enum WebinarInteractionType {
  POLL            // Multiple choice question
  QUESTION        // Open-ended Q&A prompt
  CTA             // Call to action button/card
  DOWNLOAD        // Downloadable resource
  FEEDBACK        // Rating/emoji feedback
  TIP             // Info tooltip/notification
  SPECIAL_OFFER   // Timed offer with countdown
  PAUSE           // Explicit pause with message (auto-resume or manual)
  QUIZ            // Multiple choice quiz with correct answers
  CONTACT_FORM    // Lead capture form (name, email, phone, etc.)

  @@schema("webinar")
}

enum WebinarInteractionPosition {
  TOP_LEFT
  TOP_RIGHT
  BOTTOM_LEFT
  BOTTOM_RIGHT
  CENTER
  SIDEBAR
  FULL_OVERLAY

  @@schema("webinar")
}

// Poll responses
model WebinarPollResponse {
  id              String              @id @default(cuid())
  interactionId   String
  interaction     WebinarInteraction  @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  registrationId  String
  registration    WebinarRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  // Response data
  selectedOptions Int[]               // For polls: indices of selected options
  textResponse    String?             @db.Text // For open questions
  rating          Int?                // For feedback (1-5 or emoji index)

  respondedAt     DateTime            @default(now())

  @@unique([interactionId, registrationId])
  @@index([interactionId])
  @@schema("webinar")
  @@map("webinar_poll_responses")
}

// Track all interaction events (views, clicks, dismissals)
model WebinarInteractionEvent {
  id              String              @id @default(cuid())
  interactionId   String
  interaction     WebinarInteraction  @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  registrationId  String
  registration    WebinarRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  eventType       WebinarInteractionEventType
  metadata        Json?               // Extra data (clicked URL, etc.)

  createdAt       DateTime            @default(now())

  @@index([interactionId, eventType])
  @@index([registrationId])
  @@schema("webinar")
  @@map("webinar_interaction_events")
}

enum WebinarInteractionEventType {
  VIEWED          // Interaction was shown
  RESPONDED       // User responded to poll/feedback
  CLICKED         // CTA/link clicked
  DISMISSED       // User closed it
  DOWNLOADED      // Download initiated

  @@schema("webinar")
}

// ===========================================
// Webinar Chat
// ===========================================

model WebinarChatMessage {
  id              String              @id @default(cuid())
  webinarId       String
  webinar         Webinar             @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  registrationId  String?             // null = system/moderator/simulated
  registration    WebinarRegistration? @relation(fields: [registrationId], references: [id], onDelete: SetNull)

  // For simulated chat (pre-recorded messages)
  isSimulated     Boolean             @default(false)
  appearsAt       Int?                // Seconds into video (for simulated)

  // Message content
  senderName      String
  message         String              @db.Text

  // Message type/role
  isFromModerator Boolean             @default(false)
  isPrivateReply  Boolean             @default(false) // Only visible to original sender
  replyToId       String?             // ID of message being replied to

  // Moderation
  isHidden        Boolean             @default(false)
  hiddenBy        String?             // Admin who hid it
  hiddenAt        DateTime?

  createdAt       DateTime            @default(now())

  @@index([webinarId, createdAt])
  @@index([webinarId, appearsAt])
  @@index([registrationId])
  @@schema("webinar")
  @@map("webinar_chat_messages")
}

// ===========================================
// Webinar Notifications (Automations)
// ===========================================

// Notification template/rule definition
model WebinarNotification {
  id              String              @id @default(cuid())
  webinarId       String
  webinar         Webinar             @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  // Trigger configuration
  triggerType     NotificationTriggerType
  triggerMinutes  Int                 // Relative timing: +30 = 30min after, -15 = 15min before

  // Template reference (for default notifications)
  // Points to template files in content/email-templates/webinar/
  // null = custom notification with inline content
  templateKey     String?             // e.g., "registration-confirmation", "reminder-24h"

  // Conditions (JSON for AFTER_END triggers)
  // Examples:
  // { "attended": false }
  // { "watchedPercent": { "lt": 30 } }
  // { "AND": [{ "watchedPercent": { "gte": 50 } }, { "ctaClicked": true }] }
  conditions      Json?

  // Channel
  channel         NotificationChannel @default(EMAIL)

  // Email content (in the webinar's language)
  // If created from a template, these are pre-filled and editable
  subject         String?             // Required for EMAIL
  previewText     String?             // Email preview text (appears in inbox)
  bodyHtml        String?             @db.Text // Rich HTML content with template variables
  bodyText        String?             @db.Text // Plain text version / SMS content
  bodyDesign      String?             @db.Text // Maily.to JSON design for editor

  // Email deliverability settings (optional overrides)
  // If null, defaults from Settings.emailFromName/emailFromAddress are used
  fromName        String?             // Custom "From" name (e.g., "Nebiswera Team")
  fromEmail       String?             // Custom "From" email address
  replyTo         String?             // Custom reply-to email

  // Actions/Rules (executed when notification is sent)
  // JSON array of actions: [{ "type": "TAG_CONTACT", "tagId": "..." }, ...]
  actions         Json?

  // Settings
  isActive        Boolean             @default(true)
  isDefault       Boolean             @default(false) // System default vs user-created

  // Display order in UI timeline
  sortOrder       Int                 @default(0)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  queueItems      WebinarNotificationQueue[]
  logs            WebinarNotificationLog[]

  @@index([webinarId, triggerType])
  @@index([webinarId, isActive])
  @@schema("webinar")
  @@map("webinar_notifications")
}

enum NotificationTriggerType {
  AFTER_REGISTRATION   // X minutes after they register (0 = immediate)
  BEFORE_START         // Y minutes before webinar starts (per session)
  AFTER_END            // Z minutes after webinar ends (per session, with conditions)

  @@schema("webinar")
}

enum NotificationChannel {
  EMAIL
  SMS

  @@schema("webinar")
}

// Queue for scheduled notifications (processed by cron)
model WebinarNotificationQueue {
  id              String              @id @default(cuid())
  notificationId  String
  notification    WebinarNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  registrationId  String
  registration    WebinarRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  // Scheduling
  scheduledAt     DateTime            // When to send
  processedAt     DateTime?           // When actually processed

  // Status
  status          NotificationQueueStatus @default(PENDING)

  // Retry tracking
  attempts        Int                 @default(0)
  lastError       String?             @db.Text

  createdAt       DateTime            @default(now())

  @@index([status, scheduledAt])
  @@index([registrationId])
  @@index([notificationId])
  @@schema("webinar")
  @@map("webinar_notification_queue")
}

enum NotificationQueueStatus {
  PENDING         // Waiting to be processed
  PROCESSING      // Currently being processed
  SENT            // Successfully sent
  FAILED          // Failed after retries
  SKIPPED         // Condition not met at send time
  CANCELLED       // Manually cancelled

  @@schema("webinar")
}

// Log of all sent notifications
model WebinarNotificationLog {
  id              String              @id @default(cuid())
  notificationId  String
  notification    WebinarNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  registrationId  String
  registration    WebinarRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  // Channel used
  channel         NotificationChannel

  // Email specific
  emailLogId      String?             // Reference to EmailLog.id
  subject         String?             // Actual subject sent (after variable substitution)

  // SMS specific
  smsProvider     String?             // Provider used
  smsMessageId    String?             // Provider's message ID

  // Status
  status          NotificationLogStatus @default(SENT)
  errorMessage    String?             @db.Text

  // Metadata
  metadata        Json?               // Provider response, rendered content hash, etc.

  sentAt          DateTime            @default(now())

  @@index([notificationId])
  @@index([registrationId])
  @@index([sentAt])
  @@index([emailLogId])
  @@schema("webinar")
  @@map("webinar_notification_logs")
}

enum NotificationLogStatus {
  SENT            // Delivered to provider
  DELIVERED       // Confirmed delivery
  FAILED          // Failed to send
  BOUNCED         // Email bounced
  OPENED          // Email opened (from webhook)
  CLICKED         // Link clicked (from webhook)

  @@schema("webinar")
}

// ===========================================
// Webinar Automation Rules (Tag Assignment)
// ===========================================

model WebinarAutomationRule {
  id              String              @id @default(cuid())
  webinarId       String
  webinar         Webinar             @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  // Trigger event
  trigger         WebinarAutomationTrigger

  // Action: Assign tags to contact
  tagIds          String[]            // Tag IDs to assign when trigger fires

  // Settings
  enabled         Boolean             @default(true)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([webinarId, trigger])
  @@schema("webinar")
  @@map("webinar_automation_rules")
}

enum WebinarAutomationTrigger {
  REGISTERED      // When user registers for webinar
  ATTENDED        // When user joins watch room
  COMPLETED       // When user completes webinar (watches past threshold)
  MISSED          // When user registers but doesn't attend scheduled session

  @@schema("webinar")
}

// ===========================================
// Webinar Analytics
// ===========================================

model WebinarAnalyticsEvent {
  id              String              @id @default(cuid())
  webinarId       String
  webinar         Webinar             @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  registrationId  String?
  registration    WebinarRegistration? @relation(fields: [registrationId], references: [id], onDelete: SetNull)

  // Event info
  eventType       WebinarAnalyticsEventType
  videoPosition   Int?                // Seconds into video
  metadata        Json?               // Event-specific data

  // Session context
  sessionId       String?
  sessionType     WebinarSessionType?

  // Client info (for debugging)
  userAgent       String?
  ipAddress       String?

  createdAt       DateTime            @default(now())

  @@index([webinarId, eventType])
  @@index([webinarId, createdAt])
  @@index([registrationId, createdAt])
  @@schema("webinar")
  @@map("webinar_analytics_events")
}

enum WebinarAnalyticsEventType {
  // Page events
  LANDING_PAGE_VIEW
  REGISTRATION_STARTED
  REGISTRATION_COMPLETED
  REGISTRATION            // Backwards compat alias

  // Attendance events
  JOINED_WAITING_ROOM
  WEBINAR_STARTED
  WEBINAR_ENDED
  LEFT_EARLY
  REJOINED
  ATTENDANCE              // First joined the webinar

  // Engagement events
  CHAT_SENT
  POLL_ANSWERED
  CTA_CLICKED
  DOWNLOAD_CLICKED
  QUESTION_SUBMITTED
  FEEDBACK_GIVEN
  REACTION_SENT

  // Video events
  VIDEO_HEARTBEAT     // Sent every 30 seconds
  VIDEO_BUFFERING
  VIDEO_ERROR
  VIDEO_QUALITY_CHANGE

  // Replay events
  REPLAY_STARTED
  REPLAY_SEEKED
  REPLAY_COMPLETED

  @@schema("webinar")
}

// ===========================================
// Video Processing (Bunny.net Stream)
// ===========================================

model VideoProcessingJob {
  id              String                @id @default(cuid())
  webinarId       String                @unique
  webinar         Webinar               @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  status          VideoProcessingStatus @default(PENDING)
  progress        Int                   @default(0) // 0-100

  // Source
  originalUrl     String                // Original upload URL
  originalSize    BigInt?               // File size in bytes

  // Bunny.net Stream video ID
  bunnyVideoId    String?               @map("coconutJobId") // Mapped to preserve existing column

  // Output (populated after processing)
  hlsUrl          String?               // Bunny Stream HLS URL
  thumbnailUrl    String?               // Bunny Stream thumbnail URL
  duration        Int?                  // Duration in seconds

  // Processing info
  startedAt       DateTime?
  completedAt     DateTime?
  error           String?
  retryCount      Int                   @default(0)

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([bunnyVideoId])
  @@schema("webinar")
  @@map("video_processing_jobs")
}

enum VideoProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@schema("webinar")
}

// ===========================================
// LMS Schema - Learning Management System
// ===========================================

// ----------------
// CORE ENTITIES
// ----------------

model Course {
  id          String   @id @default(cuid())

  // Basic Info
  slug        String   @unique
  title       String
  description String?  @db.Text
  thumbnail   String?  // Bunny CDN URL
  locale      String   @default("ka") // "ka" or "en"

  // Access Control
  accessType  CourseAccessType @default(FREE)
  price       Decimal?  @db.Decimal(10, 2) // For future payment system
  currency    String?   @default("GEL")

  // Settings (JSON)
  // {
  //   videoCompletionThreshold: number (0-100, default 90)
  //   sequentialLock: boolean (must complete previous)
  //   dripContent: boolean (unlock over time)
  //   dripIntervalDays: number (days between unlocks)
  //   expirationDays: number | null (access expires after enrollment)
  //   certificateEnabled: boolean
  //   certificateTemplate: string | null
  // }
  settings    Json      @default("{}")

  // Publishing
  status      CourseStatus @default(DRAFT)
  version     Int       @default(1)
  publishedAt DateTime?

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  modules     LmsModule[]
  lessons     LmsLesson[]  // Direct lessons (no module)
  enrollments Enrollment[]
  prerequisites CoursePrerequisite[] @relation("course")
  prerequisiteFor CoursePrerequisite[] @relation("prerequisite")
  notifications CourseNotificationConfig[]
  analyticsEvents CourseAnalyticsEvent[]
  quizzes     LmsQuiz[]

  @@index([status])
  @@index([slug])
  @@index([locale])
  @@index([createdAt])
  @@schema("lms")
  @@map("courses")
}

enum CourseAccessType {
  OPEN  // No login, localStorage tracking
  FREE  // Login required, free access
  PAID  // Login + enrollment required

  @@schema("lms")
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@schema("lms")
}

model CoursePrerequisite {
  id             String   @id @default(cuid())
  courseId       String
  prerequisiteId String

  course       Course @relation("course", fields: [courseId], references: [id], onDelete: Cascade)
  prerequisite Course @relation("prerequisite", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([courseId, prerequisiteId])
  @@schema("lms")
  @@map("course_prerequisites")
}

model LmsModule {
  id          String   @id @default(cuid())
  courseId    String

  // Basic Info
  title       String
  description String?  @db.Text

  // Ordering
  order       Int      @default(0)

  // Drip Content
  availableAfterDays Int? // Days after enrollment to unlock

  // Content Blocks (JSON array)
  // ContentBlock[]: { id, type, order, ...type-specific data }
  contentBlocks Json    @default("[]")

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     LmsLesson[]

  @@index([courseId, order])
  @@schema("lms")
  @@map("modules")
}

model LmsLesson {
  id          String   @id @default(cuid())
  courseId    String
  moduleId    String?  // Nullable - lesson can be directly under course

  // Basic Info
  title       String
  description String?  @db.Text

  // Ordering
  order       Int      @default(0)

  // Drip Content
  availableAfterDays Int? // Days after enrollment to unlock

  // Content Blocks (JSON array)
  contentBlocks Json    @default("[]")

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module      LmsModule? @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  parts       LmsPart[]

  @@index([courseId, order])
  @@index([moduleId, order])
  @@schema("lms")
  @@map("lessons")
}

model LmsPart {
  id          String   @id @default(cuid())
  lessonId    String

  // Basic Info
  title       String
  description String?  @db.Text

  // Ordering
  order       Int      @default(0)

  // Content Blocks (JSON array)
  contentBlocks Json    @default("[]")

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  lesson      LmsLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  progress    PartProgress[]

  @@index([lessonId, order])
  @@schema("lms")
  @@map("parts")
}

// ----------------
// QUIZ SYSTEM
// ----------------

model LmsQuiz {
  id          String   @id @default(cuid())
  courseId    String   // Quiz belongs to a course

  // Basic Info
  title       String
  description String?  @db.Text

  // Settings
  passingScore    Int      @default(70) // Percentage to pass
  maxAttempts     Int?     // Null = unlimited
  cooldownMinutes Int?     // Time between retry attempts
  shuffleQuestions Boolean @default(false)
  shuffleOptions  Boolean  @default(false)
  showCorrectAnswers Boolean @default(true) // Show after submission

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions   LmsQuizQuestion[]
  attempts    LmsQuizAttempt[]

  @@index([courseId])
  @@schema("lms")
  @@map("quizzes")
}

model LmsQuizQuestion {
  id          String   @id @default(cuid())
  quizId      String

  // Question
  type        LmsQuestionType
  question    String   @db.Text
  explanation String?  @db.Text // Shown after answer
  points      Int      @default(1)
  order       Int      @default(0)

  // Options (for multiple choice) - JSON array
  // QuizOption[]: { id: string, text: string, isCorrect: boolean }
  options     Json     @default("[]")

  // For text/essay questions
  correctAnswer String? @db.Text // For short answer validation

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  quiz        LmsQuiz  @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers     LmsQuizAnswer[]

  @@index([quizId, order])
  @@schema("lms")
  @@map("quiz_questions")
}

enum LmsQuestionType {
  MULTIPLE_CHOICE_SINGLE   // Radio buttons
  MULTIPLE_CHOICE_MULTIPLE // Checkboxes
  TRUE_FALSE
  SHORT_ANSWER             // Text input, auto-graded
  ESSAY                    // Long text, manual grading

  @@schema("lms")
}

model LmsQuizAttempt {
  id          String   @id @default(cuid())
  quizId      String
  userId      String?  // Null for open courses
  anonymousId String?  // For open courses (localStorage ID)

  // Results
  score       Int?     // Percentage (null if not graded yet)
  passed      Boolean?
  startedAt   DateTime @default(now())
  completedAt DateTime?

  // Relations
  quiz        LmsQuiz  @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers     LmsQuizAnswer[]

  @@index([quizId])
  @@index([userId])
  @@index([anonymousId])
  @@schema("lms")
  @@map("quiz_attempts")
}

model LmsQuizAnswer {
  id          String   @id @default(cuid())
  attemptId   String
  questionId  String

  // Answer
  selectedOptions Json?   // Array of option IDs for multiple choice
  textAnswer      String? @db.Text // For text/essay

  // Grading
  isCorrect   Boolean?
  pointsAwarded Int?
  feedback    String?  @db.Text // Manual feedback for essays

  // Relations
  attempt     LmsQuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question    LmsQuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
  @@schema("lms")
  @@map("quiz_answers")
}

// ----------------
// ENROLLMENT & PROGRESS
// ----------------

model Enrollment {
  id          String   @id @default(cuid())
  courseId    String
  userId      String

  // Status
  status      EnrollmentStatus @default(ACTIVE)

  // Access
  enrolledAt  DateTime @default(now())
  expiresAt   DateTime? // Based on course settings

  // Progress Summary (cached for performance)
  progressPercent Int    @default(0)
  completedAt     DateTime?

  // Certificate (certificateId is the verification code, not a FK)
  certificateId   String?
  certificateUrl  String?
  certificateIssuedAt DateTime?

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  partProgress     PartProgress[]
  notificationLogs CourseNotificationLog[]
  notificationQueue CourseNotificationQueue[]

  @@unique([courseId, userId])
  @@index([userId])
  @@index([status])
  @@schema("lms")
  @@map("enrollments")
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  SUSPENDED // Admin suspended access

  @@schema("lms")
}

model PartProgress {
  id           String   @id @default(cuid())
  enrollmentId String
  partId       String

  // Progress
  status       LmsProgressStatus @default(NOT_STARTED)

  // Video/Audio tracking
  watchTime    Int      @default(0) // Seconds watched
  duration     Int?     // Total duration (cached from content)
  watchPercent Int      @default(0) // Percentage watched

  // Completion
  completedAt  DateTime?
  completedBy  LmsCompletionType? // How it was completed

  // Metadata
  lastAccessedAt DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  enrollment  Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  part        LmsPart    @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, partId])
  @@index([enrollmentId])
  @@index([partId])
  @@schema("lms")
  @@map("part_progress")
}

enum LmsProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED

  @@schema("lms")
}

enum LmsCompletionType {
  AUTO_VIDEO      // Video watched past threshold
  AUTO_QUIZ       // Quiz passed
  MANUAL          // User marked complete
  ADMIN           // Admin marked complete

  @@schema("lms")
}

// ----------------
// NOTIFICATIONS
// ----------------

model CourseNotificationConfig {
  id          String   @id @default(cuid())
  courseId    String

  // Trigger configuration
  trigger         CourseNotificationTrigger
  triggerMinutes  Int     @default(0)  // Relative timing: 0 = immediate, 1440 = 24h after
  // For BEFORE_EXPIRATION: days before expiration (stored as negative minutes internally)
  // For ON_INACTIVITY: days of inactivity (stored as positive minutes: 7 days = 10080)

  // Template reference (for default notifications)
  // Points to template files in content/email-templates/courses/
  // null = custom notification with inline content
  templateKey     String?   // e.g., "enrollment-welcome", "course-completed"

  // Conditions (JSON for conditional sending)
  // Examples:
  // { "progressPercent": { "eq": 0 } } - Not started
  // { "progressPercent": { "gte": 50 } } - At least 50%
  // { "AND": [{ "progressPercent": { "gte": 50 } }, { "quizzesPassed": { "gte": 1 } }] }
  conditions      Json?

  // Channel
  channel         LmsNotificationChannel @default(EMAIL)

  // Email content (in the course's language)
  // If created from a template, these are pre-filled and editable
  subject         String?             // Required for EMAIL
  previewText     String?             // Email preview text (appears in inbox)
  bodyHtml        String?   @db.Text  // Rich HTML content with template variables
  bodyText        String?   @db.Text  // Plain text version
  bodyDesign      String?   @db.Text  // Maily.to JSON design for editor

  // Email deliverability settings (optional overrides)
  // If null, defaults from Settings.emailFromName/emailFromAddress are used
  fromName        String?             // Custom "From" name
  fromEmail       String?             // Custom "From" email address
  replyTo         String?             // Custom reply-to email

  // Actions/Rules (executed when notification is sent)
  // JSON array of actions: [{ "type": "TAG_CONTACT", "tagId": "..." }, ...]
  actions         Json?

  // Settings
  isActive        Boolean  @default(true)
  isDefault       Boolean  @default(false) // System default vs user-created

  // Display order in UI
  sortOrder       Int      @default(0)

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  logs        CourseNotificationLog[]
  queue       CourseNotificationQueue[]

  @@index([courseId, trigger])
  @@index([courseId, isActive])
  @@schema("lms")
  @@map("course_notification_configs")
}

enum CourseNotificationTrigger {
  AFTER_ENROLLMENT        // X minutes after enrollment (0 = immediate)
  ON_COURSE_START         // When user accesses first lesson
  ON_LESSON_COMPLETE      // When user completes any lesson
  ON_MODULE_COMPLETE      // When user completes any module
  ON_COURSE_COMPLETE      // When course reaches 100%
  ON_QUIZ_PASS            // When quiz passed
  ON_QUIZ_FAIL            // When quiz failed
  ON_INACTIVITY           // After X days without activity (cron-based)
  BEFORE_EXPIRATION       // X days before enrollment expires (cron-based)
  ON_CERTIFICATE_ISSUED   // When certificate generated

  @@schema("lms")
}

enum LmsNotificationChannel {
  EMAIL
  // SMS - future support

  @@schema("lms")
}

// Queue for scheduled notifications (processed by cron)
model CourseNotificationQueue {
  id              String   @id @default(cuid())
  configId        String
  enrollmentId    String

  // Scheduling
  scheduledAt     DateTime            // When to send
  processedAt     DateTime?           // When actually processed

  // Status
  status          LmsNotificationQueueStatus @default(PENDING)

  // Retry tracking
  attempts        Int      @default(0)
  lastError       String?  @db.Text

  // Metadata (snapshot for condition evaluation at send time)
  // Stores: lessonId, moduleId, quizId, etc. depending on trigger
  metadata        Json?

  createdAt       DateTime @default(now())

  // Relations
  config          CourseNotificationConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  enrollment      Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([status, scheduledAt])
  @@index([configId])
  @@index([enrollmentId])
  @@schema("lms")
  @@map("course_notification_queue")
}

enum LmsNotificationQueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  SKIPPED
  CANCELLED

  @@schema("lms")
}

// Log of all sent notifications
model CourseNotificationLog {
  id              String   @id @default(cuid())
  configId        String
  enrollmentId    String

  // Channel used
  channel         LmsNotificationChannel @default(EMAIL)

  // Email specific
  emailLogId      String?             // Reference to EmailLog.id for unified tracking
  subject         String?             // Actual subject sent (after variable substitution)

  // Status
  status          LmsNotificationLogStatus @default(SENT)
  errorMessage    String?  @db.Text

  // Metadata
  metadata        Json?               // Provider response, rendered content hash, etc.

  sentAt          DateTime @default(now())

  // Relations
  config          CourseNotificationConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  enrollment      Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([enrollmentId])
  @@index([sentAt])
  @@index([emailLogId])
  @@schema("lms")
  @@map("course_notification_logs")
}

enum LmsNotificationLogStatus {
  SENT
  DELIVERED
  FAILED
  BOUNCED
  OPENED
  CLICKED

  @@schema("lms")
}

// ----------------
// ANALYTICS
// ----------------

model CourseAnalyticsEvent {
  id          String   @id @default(cuid())
  courseId    String
  userId      String?
  anonymousId String?  // For open courses
  enrollmentId String?

  // Event
  eventType   CourseEventType
  eventData   Json     @default("{}")

  // Context
  partId      String?
  lessonId    String?
  moduleId    String?
  quizId      String?

  // Client Info
  userAgent   String?
  ipAddress   String?

  // Timestamp
  createdAt   DateTime @default(now())

  // Relations
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId, eventType])
  @@index([courseId, createdAt])
  @@index([userId])
  @@index([anonymousId])
  @@index([enrollmentId])
  @@schema("lms")
  @@map("course_analytics_events")
}

enum CourseEventType {
  // Enrollment
  ENROLLED
  ENROLLMENT_EXPIRED

  // Navigation
  COURSE_VIEWED
  MODULE_VIEWED
  LESSON_VIEWED
  PART_VIEWED

  // Content
  VIDEO_STARTED
  VIDEO_PROGRESS     // Every 10% milestone
  VIDEO_COMPLETED
  VIDEO_SEEKED
  VIDEO_PAUSED
  VIDEO_UNMUTED      // Engagement signal for muted autoplay videos
  AUDIO_STARTED
  AUDIO_COMPLETED
  FILE_DOWNLOADED
  EMBED_VIEWED

  // Progress
  PART_COMPLETED
  LESSON_COMPLETED
  MODULE_COMPLETED
  COURSE_COMPLETED

  // Quiz
  QUIZ_STARTED
  QUIZ_SUBMITTED
  QUIZ_PASSED
  QUIZ_FAILED
  QUIZ_RETRIED

  // Certificate
  CERTIFICATE_GENERATED
  CERTIFICATE_DOWNLOADED

  // Engagement
  RESUMED_AFTER_INACTIVITY

  @@schema("lms")
}

